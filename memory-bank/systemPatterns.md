# システムパターンとアーキテクチャ

## 全体アーキテクチャ

### コア処理パイプライン
```
YAMLファイル → JSON変換 → スキーマ解析 → セマンティクス生成 → 名前解決 → 定義生成 → コード生成
```

### 主要コンポーネント
1. **MooresmasterSourceGenerator**: エントリーポイント
2. **JsonSchemaParser**: スキーマ解析エンジン
3. **SemanticsGenerator**: 意味解析処理
4. **NameResolver**: 名前衝突解決
5. **DefinitionGenerator**: 型定義生成
6. **CodeGenerator**: C#コード生成
7. **LoaderGenerator**: ローダーコード生成

## 設計パターン

### Incremental Source Generator パターン
- Roslynの増分ソースジェネレーター機能を活用
- 変更されたファイルのみを再処理して性能を最適化
- `IIncrementalGenerator`インターフェースの実装

### Pipeline パターン
- 各処理段階を独立したコンポーネントに分離
- データの変換を段階的に実行
- 各段階での中間結果の保持と再利用

### Builder パターン
- 複雑なオブジェクト構築を段階的に実行
- 特にコード生成部分で活用

## 重要な技術的決定

### YamlDotNetの組み込み
- 外部依存を避けるためにYamlDotNetのソースコードを直接組み込み
- バージョン競合の回避
- 配布の簡素化

### スキーマテーブルによる参照管理
- `SchemaTable`クラスによる型参照の一元管理
- 循環参照の検出と解決
- 名前空間の管理

### 段階的な処理アプローチ
1. **構文解析段階**: YAMLからJSONオブジェクトへ
2. **意味解析段階**: スキーマの意味的構造の理解
3. **名前解決段階**: 型名や識別子の衝突解決
4. **コード生成段階**: 最終的なC#コードの出力

## コンポーネント間の関係

### データフロー
- `AdditionalText` → `SchemaFile` → `Schema` → `Semantics` → `Definition` → `GeneratedCode`
- 各段階で不変オブジェクトを使用してスレッドセーフティを確保

### 依存関係
- 各ジェネレーターは前段階の出力に依存
- 循環依存の回避
- 単方向のデータフロー

## エラーハンドリング戦略

### コンパイル時エラー
- スキーマ解析エラーの詳細な報告
- ソースジェネレーター診断APIの活用

### ランタイムエラー
- 生成されたローダーでの適切な例外処理
- カスタム例外型の提供

## パフォーマンス考慮事項

### メモリ効率
- 不変オブジェクトの使用
- 適切なオブジェクトプールの活用

### ビルド時間最適化
- 増分生成による不要な再処理の回避
- 効率的なファイル変更検出